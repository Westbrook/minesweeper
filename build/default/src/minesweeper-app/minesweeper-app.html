<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../minesweeper-board/minesweeper-board.html">
<link rel="import" href="../minesweeper-menu/minesweeper-menu.html">

<dom-module id="minesweeper-app">
  <template>
    <style>
      :host {
        display: flex;
        flex-direction: column;
        flex-grow: 1;

        --minesweeper-square-size: 50px;
      }
    </style>
    <minesweeper-menu difficulty="{{difficulty}}"></minesweeper-menu>
    <minesweeper-board id="board" board="[[board]]"></minesweeper-board>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class MinesweeperApp extends Polymer.Element {
      static get is() { return 'minesweeper-app'; }
      static get properties() {
        return {
          width: {
            type: Number,
            value: 0
          },
          height: {
            type: Number,
            value: 0
          },
          board: {
            type: Array,
            value: function () {
              return [];
            }
          },
          _boundMeasure: {
            type: Function,
            value: function() {
              return this.measure.bind(this);
            }
          },
          _boundStartNewGame: {
            type: Function,
            value: function() {
              return this.startNewGame.bind(this);
            }
          },
          _boundGameOver: {
            type: Function,
            value: function() {
              return this._gameOver.bind(this);
            }
          },
          difficulty: {
            type: Number,
            value: 5
          },
          squareSize: {
            type: Number,
            value: 50
          }
        };
      }

      connectedCallback() {
        super.connectedCallback();
        window.requestAnimationFrame(this._boundMeasure);
        this.addEventListener('minesweeper-new-game', this._boundStartNewGame);
        this.addEventListener('minesweeper-game-over', this._boundGameOver);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this.removeEventListener('minesweeper-new-game', this._boundStartNewGame);
        this.removeEventListener('minesweeper-game-over', this._boundGameOver);
      }

      measure() {
        var width = this.$.board.offsetWidth;
        var height = this.$.board.offsetHeight;
        this.setProperties({width: width, height: height});
        this.startNewGame();
      }

      startNewGame() {
        this.createBoard();
      }

      createBoard() {
        var across = Math.floor(this.width / this.squareSize);
        var down = Math.floor(this.height / this.squareSize);
        var downCount = down;
        var board = Array(across);
        while (across) {
          across--;
          board[across] = Array(down);
          down = downCount;
          while (down) {
            down--;
            board[across][down] = this._layMine();
          }
        }
        this.set('board', board);
      }

      _layMine() {
        var isMine = Math.round(Math.random() * 100);
        var square = {
          mine: isMine <= this.difficulty * 4,
          played: false
        }
        return square;
      }

      _gameOver() {
        if (window.confirm('Game Over.\n\n\nStart a new game?')) {
          this.startNewGame();
        }
      }
    }

    window.customElements.define(MinesweeperApp.is, MinesweeperApp);
  </script>
</dom-module>
