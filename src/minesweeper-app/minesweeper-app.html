<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../minesweeper-square/minesweeper-square.html">

<dom-module id="minesweeper-app">
  <template>
    <style>
      :host {
        display: block;
        flex-grow: 1;
        display: flex;
        flex-wrap: wrap;
        flex-direction: column;

        --minesweeper-square-size: 50px;
      }
    </style>
    <dom-repeat items="{{board}}" index-as="across" as="column">
      <template>
        <dom-repeat items="{{column}}" as="square" index-as="down">
          <template>
            <minesweeper-square
              mine="[[square.mine]]"
              played="{{square.played}}"
              on-played-changed="_played"
              column="[[across]]"
              row="[[down]]"
              neighbors="[[_getNeighboringMines(board, across, down)]]"
            ></minesweeper-square>
          </template>
        </dom-repeat>
      </template>
    </dom-repeat>
  </template>

  <script>
    /**
     * @customElement
     * @polymer
     */
    class MinesweeperApp extends Polymer.Element {
      static get is() { return 'minesweeper-app'; }
      static get properties() {
        return {
          width: {
            type: Number,
            value: 0
          },
          height: {
            type: Number,
            value: 0
          },
          board: {
            type: Array,
            value: function () {
              return [];
            }
          },
          _boundMeasure: {
            type: Function,
            value: function() {
              return this.measure.bind(this);
            }
          },
          _boundPlayed: {
            type: Function,
            value: function() {
              return this._played.bind(this);
            }
          },
          _boundStartNewGame: {
            type: Function,
            value: function() {
              return this.startNewGame.bind(this);
            }
          },
          difficulty: {
            type: Number,
            value: 1
          },
          squareSize: {
            type: Number,
            value: 50
          }
        };
      }
      connectedCallback() {
        super.connectedCallback();
        window.requestAnimationFrame(this._boundMeasure);
        this.addEventListener('minesweeper-played', this._boundPlayed);
        this.addEventListener('minesweeper-game-over', this._boundStartNewGame);
      }

      disconnectedCallback() {
        super.disconnectedCallback();
        this.removeEventListener('minesweeper-played', this._boundPlayed);
        this.removeEventListener('minesweeper-game-over', this._boundStartNewGame);
      }

      measure() {
        var width = this.offsetWidth;
        var height = this.offsetHeight;
        this.setProperties({width: width, height: height});
        this.startNewGame();
      }

      startNewGame() {
        this.createBoard();
      }

      createBoard() {
        var across = Math.floor(this.width / this.squareSize);
        var down = Math.floor(this.height / this.squareSize);
        var downCount = down;
        var board = Array(across);
        while (across) {
          across--;
          board[across] = Array(down);
          down = downCount;
          while (down) {
            down--;
            board[across][down] = this.layMine();
          }
        }
        this.set('board', board);
      }
      layMine() {
        var isMine = Math.round(Math.random() * 100);
        var square = {
          mine: isMine <= this.difficulty * 4,
          played: false
        }
        return square;
      }
      _getRow(board, row) {
        return board[row];
      }
      _getNeighboringMines(board, across, down) {
        var neighbors = 0;
        for (var i = across - 1; i <= across + 1; i++) {
          if (i < 0 || i == board.length) continue;
          for (var j = down - 1; j <= down + 1; j++) {
            if (j < 0 || j == board[i].length) continue;
            if (i == across && j == down) continue;
            if (board[i][j].mine) {
              neighbors++;
            }
          }
        }
        return neighbors;
      }
      _playNeighbors(across, down) {
        for (var i = across - 1; i <= across + 1; i++) {
          if (i < 0 || i == this.board.length) continue;
          for (var j = down - 1; j <= down + 1; j++) {
            if (j < 0 || j == this.board[i].length) continue;
            if (!this.board[i][j].mine && !this.board[i][j].played) {
              this.set(['board', i, j, 'played'], true);
              this._playNeighbors(i, j);
            }
          }
        }
      }

      _played(e) {
        if (e.detail.value == true) {
          var column = e.target.column;
          var row = e.target.row;
          this._playNeighbors(column, row);
          if (this.board[column][row].mine) {
            this._gameOver();
          }
        }
      }

      _gameOver() {
        if (window.confirm('Game Over.\n\n\nStart a new game?')) {
          this.startNewGame();
        }
      }
    }

    window.customElements.define(MinesweeperApp.is, MinesweeperApp);
  </script>
</dom-module>
